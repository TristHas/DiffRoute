
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Technical reference and quickstart guides for diffroute.">
      
      
      
      
        <link rel="prev" href="../../api/">
      
      
        <link rel="next" href="../custom_irf/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Routing a RAPID Project - DiffRoute Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#routing-a-rapid-project" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DiffRoute Documentation" class="md-header__button md-logo" aria-label="DiffRoute Documentation" data-md-component="logo">
      
  <img src="../../diffhydro.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DiffRoute Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Routing a RAPID Project
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DiffRoute Documentation" class="md-nav__button md-logo" aria-label="DiffRoute Documentation" data-md-component="logo">
      
  <img src="../../diffhydro.png" alt="logo">

    </a>
    DiffRoute Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/single_stage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Routing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/multi_stage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-stage Routing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/data_structures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Structures
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IO
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code Structure
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Routing a RAPID Project
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Routing a RAPID Project
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-import-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      1. Import dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-load-the-rapid-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      2. Load the RAPID configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-configure-the-staged-router" class="md-nav__link">
    <span class="md-ellipsis">
      3. Configure the staged router
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-load-rapid-runoff-forcings-from-netcdf" class="md-nav__link">
    <span class="md-ellipsis">
      4. Load RAPID runoff forcings from NetCDF
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-route-the-forcings" class="md-nav__link">
    <span class="md-ellipsis">
      5. Route the forcings
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../custom_irf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Defining a Custom IRF
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-import-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      1. Import dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-load-the-rapid-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      2. Load the RAPID configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-configure-the-staged-router" class="md-nav__link">
    <span class="md-ellipsis">
      3. Configure the staged router
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-load-rapid-runoff-forcings-from-netcdf" class="md-nav__link">
    <span class="md-ellipsis">
      4. Load RAPID runoff forcings from NetCDF
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-route-the-forcings" class="md-nav__link">
    <span class="md-ellipsis">
      5. Route the forcings
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="routing-a-rapid-project">Routing a RAPID Project<a class="headerlink" href="#routing-a-rapid-project" title="Permanent link">&para;</a></h1>
<p>This tutorial walks through configuring DiffRoute against RAPID inputs, covering graph ingestion, staged routing, and preparation of runoff forcings stored as NetCDF. 
Each step mirrors how you would wire DiffRoute into an operational RAPID deployment.
In this tutorial, we suppose a standard RAPID project with CSV definition files (<code>rapid_connect.csv</code>, <code>k.csv</code>, <code>x.csv</code>, <code>riv_bas_id.csv</code>) 
and NetCDF input runoff file (<code>input.nc</code>) stored in a same directory.</p>
<h2 id="1-import-dependencies">1. Import dependencies<a class="headerlink" href="#1-import-dependencies" title="Permanent link">&para;</a></h2>
<p>Start by importing the utilities needed to read RAPID configurations, manage paths, load NetCDF runoff with <code>xarray</code>, and move data into PyTorch tensors.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">from</span> <span class="nn">diffroute</span> <span class="kn">import</span> <span class="n">LTIStagedRouter</span>
<span class="kn">from</span> <span class="nn">diffroute.io</span> <span class="kn">import</span> <span class="n">read_rapid_graph</span>
</code></pre></div>
<h2 id="2-load-the-rapid-configuration">2. Load the RAPID configuration<a class="headerlink" href="#2-load-the-rapid-configuration" title="Permanent link">&para;</a></h2>
<p><code>read_rapid_graph</code> parses the standard RAPID CSV files (<code>rapid_connect.csv</code>, <code>k.csv</code>, <code>x.csv</code>, <code>riv_bas_id.csv</code>) 
and materialises them as either a <code>RivTree</code> or a <code>RivTreeCluster</code>, depending on the partitioning thresholds you provide.</p>
<div class="highlight"><pre><span></span><code><span class="n">vpu_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/data/rapid/VPU1201&quot;</span><span class="p">)</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">read_rapid_graph</span><span class="p">(</span>
    <span class="n">vpu_root</span><span class="p">,</span>
    <span class="n">plength_thr</span><span class="o">=</span><span class="mi">30_000</span><span class="p">,</span>  <span class="c1"># optional: segment the network</span>
    <span class="n">node_thr</span><span class="o">=</span><span class="mi">600</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="3-configure-the-staged-router">3. Configure the staged router<a class="headerlink" href="#3-configure-the-staged-router" title="Permanent link">&para;</a></h2>
<p><code>LTIStagedRouter</code> accepts the same high-level hyper-parameters as <code>LTIRouter</code> while handling clustered networks transparently. 
You can tune <code>max_delay</code> and <code>dt</code> to match your hydrological assumptions.</p>
<div class="highlight"><pre><span></span><code><span class="n">router</span> <span class="o">=</span> <span class="n">LTIStagedRouter</span><span class="p">(</span>
    <span class="n">max_delay</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="4-load-rapid-runoff-forcings-from-netcdf">4. Load RAPID runoff forcings from NetCDF<a class="headerlink" href="#4-load-rapid-runoff-forcings-from-netcdf" title="Permanent link">&para;</a></h2>
<p>Load the NetCDF input runoff into an xarray and order the catchments according to the <code>gs.node_idxs</code> ordering.
Then convert the xarray data into the <code>[batch, catchments, time]</code> tensor layout expected by the router</p>
<div class="highlight"><pre><span></span><code><span class="n">runoff_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">vpu_root</span> <span class="o">/</span> <span class="s2">&quot;input.nc&quot;</span><span class="p">)</span>
<span class="n">runoff_da</span> <span class="o">=</span> <span class="n">runoff_ds</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;reach_id&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">reach_id</span><span class="o">=</span><span class="n">gs</span><span class="o">.</span><span class="n">node_idxs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">runoff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">runoff_da</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div>
<h2 id="5-route-the-forcings">5. Route the forcings<a class="headerlink" href="#5-route-the-forcings" title="Permanent link">&para;</a></h2>
<p>Once the forcings follow the expected device and layout, invoke the router. </p>
<div class="highlight"><pre><span></span><code><span class="n">discharge</span> <span class="o">=</span> <span class="n">router</span><span class="p">(</span><span class="n">runoff</span><span class="p">,</span> <span class="n">gs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">discharge</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>The pipeline above is fully differentiable, so you can backpropagate through runoff inputs or Muskingum parameters when calibrating against observations.</li>
<li>Swap the synthetic NetCDF for your production runoff forcings to reproduce an end-to-end RAPID routing workflow with DiffRoute.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>