
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Technical reference and quickstart guides for diffroute.">
      
      
      
      
        <link rel="prev" href="../single_stage/">
      
      
        <link rel="next" href="../data_structures/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Multi-stage Routing - DiffRoute Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#staged-routing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DiffRoute Documentation" class="md-header__button md-logo" aria-label="DiffRoute Documentation" data-md-component="logo">
      
  <img src="../../diffhydro.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DiffRoute Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Multi-stage Routing
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DiffRoute Documentation" class="md-nav__button md-logo" aria-label="DiffRoute Documentation" data-md-component="logo">
      
  <img src="../../diffhydro.png" alt="logo">

    </a>
    DiffRoute Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single_stage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Routing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Multi-stage Routing
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Multi-stage Routing
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-staging-matters" class="md-nav__link">
    <span class="md-ellipsis">
      Why staging matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#segmenting-the-graph" class="md-nav__link">
    <span class="md-ellipsis">
      Segmenting the graph
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-ltistagedrouter" class="md-nav__link">
    <span class="md-ellipsis">
      Working with LTIStagedRouter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Working with LTIStagedRouter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choosing-segmentation-thresholds" class="md-nav__link">
    <span class="md-ellipsis">
      Choosing segmentation thresholds
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visualising-the-segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      Visualising the segmentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extremely-large-problem-sizes" class="md-nav__link">
    <span class="md-ellipsis">
      Extremely large problem sizes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data_structures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Structures
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IO
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code Structure
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/rapid/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Routing a RAPID Project
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/custom_irf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Defining a Custom IRF
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-staging-matters" class="md-nav__link">
    <span class="md-ellipsis">
      Why staging matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#segmenting-the-graph" class="md-nav__link">
    <span class="md-ellipsis">
      Segmenting the graph
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-ltistagedrouter" class="md-nav__link">
    <span class="md-ellipsis">
      Working with LTIStagedRouter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Working with LTIStagedRouter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choosing-segmentation-thresholds" class="md-nav__link">
    <span class="md-ellipsis">
      Choosing segmentation thresholds
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visualising-the-segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      Visualising the segmentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extremely-large-problem-sizes" class="md-nav__link">
    <span class="md-ellipsis">
      Extremely large problem sizes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="staged-routing">Staged Routing<a class="headerlink" href="#staged-routing" title="Permanent link">&para;</a></h1>
<p>Large basins quickly push the LTIRouter routing procedure to the limits of GPU memory.
This is because the kernel aggregation stage consists in computing the transitive closure of a river graph, which, in dense form, grows as the square of the number of reaches.
The block-sparse representation of the kernel helps reduce memory and computational burden of the kernel representation and consequent operations.
However, for extremely large river networks, even the sparse representation of the kernel is too heavy for modern GPU memory capacity.</p>
<p>To adress this problem, <code>diffroute</code> exposes a staged routing functionality: 
large river networks are segmented into clusters.
Each cluster is routed sequentially according to their topological order (upstream clusters first).
The output of upstream clusters is fed as input to the routing of downstream clusters through transfer buffers.</p>
<p>This functionality is exposed through the <code>LTIStagedRouter</code> torch module and <code>RivTreeCluster</code> structure.</p>
<h2 id="why-staging-matters">Why staging matters<a class="headerlink" href="#why-staging-matters" title="Permanent link">&para;</a></h2>
<p>The worst-case memory complexity of a dense routing kernel is <span class="arithmatex">\(O(N^2 \times W / dt)\)</span>, where:</p>
<ul>
<li><span class="arithmatex">\(N\)</span> is the number of reaches (graph nodes),</li>
<li><span class="arithmatex">\(W\)</span> is the impulse response window expressed in the runoff time step unit (e.g. 10 days for daily runoffs),</li>
<li><span class="arithmatex">\(dt\)</span> is the routing temportal resolution relative to runoff (e.g. 1/24 for hourly routing of daily runoffs).</li>
</ul>
<p>Doubling the graph size can up-to-quadruple the kernel footprint before considering temporal expansion. 
For continental-scale networks at fine spatial resolution, this becomes intractable. 
Staging keeps each subgraph small so the per-cluster kernels fit comfortably in GPU memory.</p>
<h2 id="segmenting-the-graph">Segmenting the graph<a class="headerlink" href="#segmenting-the-graph" title="Permanent link">&para;</a></h2>
<p><code>diffroute</code> ships a basic segmentation utility, <code>diffroute.graph_utils.define_schedule</code>, that:
1. Scans the directed acyclic river graph and flags breakpoints when upstream routing paths exceed the <code>plength_thr</code> threshold.
2. Cuts breakpoint edges to produce weakly connected components.
3. Groups components into clusters that respect the <code>node_thr</code> size limit.
4. Tracks transfers between clusters so routed discharge can flow downstream.</p>
<p>The segmentation produces:
- <code>clusters_g</code>: a list of NetworkX subgraphs (one per cluster).
- <code>node_transfer</code>: a dictionary describing which nodes exchange discharge across cluster boundaries.</p>
<p>A <code>RivTreeCluster</code> object can be instantiated from <code>clusters_g</code> and <code>node_transfer</code>, and directly consumed by <code>LTIStagedRouter</code> that will schedule the routing through the different sub-graphs.</p>
<h2 id="working-with-ltistagedrouter">Working with <code>LTIStagedRouter</code><a class="headerlink" href="#working-with-ltistagedrouter" title="Permanent link">&para;</a></h2>
<p>The staged router wraps a standard <code>LTIRouter</code> and reuses the same IRF catalogue and parameters. A typical workflow is shown below.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">diffroute</span> <span class="kn">import</span> <span class="n">LTIStagedRouter</span><span class="p">,</span> <span class="n">RivTreeCluster</span>
<span class="kn">from</span> <span class="nn">diffroute.graph_utils</span> <span class="kn">import</span> <span class="n">define_schedule</span>

<span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda:0&quot;</span>
<span class="c1"># 1. Build or load the full river network (must be acyclic)</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="c1"># ... populate nodes with IRF parameters and edges with delays ...</span>

<span class="c1"># 2. Segment the graph into manageable clusters</span>
<span class="n">clusters_g</span><span class="p">,</span> <span class="n">node_transfer</span> <span class="o">=</span> <span class="n">define_schedule</span><span class="p">(</span>
    <span class="n">G</span><span class="p">,</span>
    <span class="n">plength_thr</span><span class="o">=</span><span class="mi">25_000</span><span class="p">,</span>   <span class="c1"># breakpoint when cumulative path length exceeds this</span>
    <span class="n">node_thr</span><span class="o">=</span><span class="mi">800</span>          <span class="c1"># maximum reaches per cluster</span>
<span class="p">)</span>

<span class="c1"># 3. Wrap the segmented network in a RivTreeCluster</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">RivTreeCluster</span><span class="p">(</span>
    <span class="n">clusters_g</span><span class="p">,</span>
    <span class="n">node_transfer</span><span class="o">=</span><span class="n">node_transfer</span><span class="p">,</span>
    <span class="n">irf_fn</span><span class="o">=</span><span class="s2">&quot;linear_storage&quot;</span><span class="p">,</span>
    <span class="n">include_index_diag</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># 4. Route runoff in stages</span>
<span class="n">router</span> <span class="o">=</span> <span class="n">LTIStagedRouter</span><span class="p">(</span>
    <span class="n">max_delay</span><span class="o">=</span><span class="mi">72</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">block_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">block_f</span><span class="o">=</span><span class="mi">128</span>
<span class="p">)</span>

<span class="n">runoff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">nodes_idx</span><span class="p">),</span> <span class="mi">168</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># [batch, reaches, time]</span>
<span class="n">discharge</span> <span class="o">=</span> <span class="n">router</span><span class="p">(</span><span class="n">runoff</span><span class="p">,</span> <span class="n">gs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">discharge</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<h3 id="choosing-segmentation-thresholds">Choosing segmentation thresholds<a class="headerlink" href="#choosing-segmentation-thresholds" title="Permanent link">&para;</a></h3>
<ul>
<li>Start with <code>node_thr</code> in the 500â€“1,000 range for GPUs with 24 GB of memory. Lower values trade more staging passes for smaller kernels.</li>
<li>Set <code>plength_thr</code> high enough to let most tributaries stay intact, but low enough to break long serial chains that inflate the kernel width.</li>
<li>For complex basins, consider manual seeding (e.g., by pre-clustering with hydrological regions) before running <code>define_schedule</code>.</li>
</ul>
<h3 id="visualising-the-segmentation">Visualising the segmentation<a class="headerlink" href="#visualising-the-segmentation" title="Permanent link">&para;</a></h3>
<p>To inspect the clustering outcome, iterate over <code>clusters_g</code> and plot each subgraph, or summarise them as shown:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters_g</span><span class="p">):</span>
    <span class="n">n_nodes</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
    <span class="n">n_edges</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cid</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_nodes</span><span class="si">}</span><span class="s2"> reaches, </span><span class="si">{</span><span class="n">n_edges</span><span class="si">}</span><span class="s2"> edges&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total transfer links: </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">tot_transfer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>This helps confirm that clusters remain balanced and that the transfer buffers stay manageable.</p>
<h3 id="extremely-large-problem-sizes">Extremely large problem sizes<a class="headerlink" href="#extremely-large-problem-sizes" title="Permanent link">&para;</a></h3>
<p>Some routing problems are so large that the full output discharge can not be held into GPU memory at once.
<code>diffroute</code> accomodates for this by allowing chunked computations using python generators:</p>
<div class="highlight"><pre><span></span><code><span class="n">runoff_generator</span> <span class="o">=</span>  <span class="n">per_subcluster_runoffs</span> <span class="c1"># List[torch.Tensor]</span>
<span class="n">discharge</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">yield_</span><span class="p">(</span><span class="n">runoff_generator</span><span class="p">,</span> <span class="n">gs</span><span class="p">)</span> <span class="c1"># Generator of output torch.Tensor discharge</span>
</code></pre></div>
<p>We recommend using <code>diffhydro</code> for surch large problems to efficiently handle chunked runoff generation. </p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>